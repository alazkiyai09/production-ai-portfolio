---
# ConfigMap for StreamProcess-Pipeline
# Contains non-sensitive configuration values
# These can be updated without restarting pods (if application supports hot-reload)
apiVersion: v1
kind: ConfigMap
metadata:
  name: streamprocess-config
  namespace: streamprocess
  labels:
    app: streamprocess-pipeline
data:
  # Application Settings
  APP_NAME: "streamprocess-pipeline"
  APP_VERSION: "1.0.0"
  ENVIRONMENT: "production"
  LOG_LEVEL: "INFO"
  DEBUG: "false"

  # API Settings
  API_HOST: "0.0.0.0"
  API_PORT: "8000"
  API_WORKERS: "4"
  API_RELOAD: "false"

  # Redis Configuration
  REDIS_HOST: "redis-service"
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_MAX_CONNECTIONS: "50"
  REDIS_SOCKET_TIMEOUT: "5"
  REDIS_SOCKET_CONNECT_TIMEOUT: "5"

  # Kafka Configuration (optional, if using Kafka instead of Redis)
  KAFKA_BOOTSTRAP_SERVERS: "kafka-service:9092"
  KAFKA_CONSUMER_GROUP: "stream-process-consumers"
  KAFKA_TOPIC_RAW: "adtech.raw.events"
  KAFKA_TOPIC_PROCESSED: "adtech.processed.events"
  KAFKA_AUTO_OFFSET_RESET: "latest"
  KAFKA_ENABLE_AUTO_COMMIT: "true"

  # PostgreSQL Configuration
  POSTGRES_HOST: "postgres-service"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "streamprocess"
  POSTGRES_POOL_SIZE: "20"
  POSTGRES_MAX_OVERFLOW: "10"
  POSTGRES_POOL_TIMEOUT: "30"
  POSTGRES_POOL_RECYCLE: "3600"
  POSTGRES_URL: "postgresql://streamprocess_user:streamprocess_pass@postgres-service:5432/streamprocess"

  # SQLAlchemy Configuration
  SQLALCHEMY_ECHO: "false"
  SQLALCHEMY_POOL_PRE_PING: "true"
  SQLALCHEMY_POOL_RECYCLE: "3600"

  # Celery Configuration
  CELERY_BROKER_URL: "redis://redis-service:6379/1"
  CELERY_RESULT_BACKEND: "redis://redis-service:6379/2"
  CELERY_TASK_TRACK_STARTED: "true"
  CELERY_TASK_TIME_LIMIT: "3600"
  CELERY_TASK_SOFT_TIME_LIMIT: "3000"
  CELERY_WORKER_PREFETCH_MULTIPLIER: "4"
  CELERY_WORKER_MAX_TASKS_PER_CHILD: "1000"
  CELERY_WORKER_CONCURRENCY: "4"

  # Flower (Celery Monitor) Configuration
  FLOWER_PORT: "5555"

  # ChromaDB Configuration
  CHROMA_HOST: "chroma-service"
  CHROMA_PORT: "8001"
  CHROMA_PERSIST_DIRECTORY: "./data/chroma"
  CHROMA_COLLECTION_NAME: "adtech_embeddings"
  CHROMA_DISTANCE_FUNCTION: "cosine"

  # Qdrant Configuration (alternative vector DB)
  QDRANT_HOST: "qdrant-service"
  QDRANT_PORT: "6333"
  QDRANT_GRPC_PORT: "6334"
  QDRANT_COLLECTION_NAME: "adtech_embeddings"
  QDRANT_VECTOR_SIZE: "384"
  QDRANT_DISTANCE: "Cosine"

  # Embedding Model Configuration
  # Using a fast, efficient model for production
  EMBEDDING_MODEL_NAME: "sentence-transformers/all-MiniLM-L6-v2"
  EMBEDDING_MODEL_DEVICE: "cpu"  # Use "cuda" if GPU nodes available
  EMBEDDING_BATCH_SIZE: "32"
  EMBEDDING_DIMENSION: "384"
  EMBEDDING_CACHE_DIR: "./cache/embeddings"
  EMBEDDING_MAX_LENGTH: "512"

  # Pipeline Configuration
  PIPELINE_BATCH_SIZE: "100"
  PIPELINE_BATCH_TIMEOUT: "5.0"
  PIPELINE_MAX_QUEUE_SIZE: "10000"
  PIPELINE_PROCESSING_INTERVAL: "1.0"
  PIPELINE_CHECKPOINT_INTERVAL: "100"

  # Ingestion Configuration
  INGESTION_MAX_PAYLOAD_SIZE: "10485760"  # 10MB
  INGESTION_RATE_LIMIT: "10000"  # per minute
  INGESTION_VALIDATE_SCHEMA: "true"
  INGESTION_DEAD_LETTER_TOPIC: "adtech.dead.letter"

  # Processing Configuration
  PROCESSING_WORKERS: "4"
  PROCESSING_QUEUE_SIZE: "1000"
  PROCESSING_RETRY_ATTEMPTS: "3"
  PROCESSING_RETRY_DELAY: "1.0"
  PROCESSING_TIMEOUT: "300"

  # Metrics and Monitoring
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  METRICS_PATH: "/metrics"
  PROMETHEUS_MULTIPROC_DIR: "./tmp/prometheus"

  # OpenTelemetry Configuration
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger-collector:4317"
  OTEL_SERVICE_NAME: "streamprocess-pipeline"
  OTEL_TRACES_SAMPLER: "parentbased_traceidratio"
  OTEL_TRACES_SAMPLER_ARG: "1.0"

  # Health Check Configuration
  HEALTH_CHECK_INTERVAL: "30"
  HEALTH_CHECK_TIMEOUT: "10"

  # CORS Configuration
  CORS_ORIGINS: '["http://localhost:3000","http://localhost:8000","https://dashboard.example.com"]'
  CORS_ALLOW_CREDENTIALS: "true"
  CORS_ALLOW_METHODS: '["*"]'
  CORS_ALLOW_HEADERS: '["*"]'
