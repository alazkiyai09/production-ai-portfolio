# ============================================================
# Enterprise-RAG: Production Docker Compose
# ============================================================
# Production deployment with Qdrant vector database

version: '3.8'

services:
  # ============================================================
  # RAG API Service
  # ============================================================
  rag-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: enterprise-rag-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - CORS_ORIGINS=http://localhost:8501,http://localhost:3000

      # LLM Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o-mini}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.1}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-1024}

      # Embedding Configuration
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      - RERANKER_MODEL=${RERANKER_MODEL:-cross-encoder/ms-marco-MiniLM-L-6-v2}

      # Retrieval Configuration
      - CHUNK_SIZE=${CHUNK_SIZE:-512}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-50}
      - TOP_K_RETRIEVAL=${TOP_K_RETRIEVAL:-20}
      - TOP_K_RERANK=${TOP_K_RERANK:-5}
      - ENABLE_BM25=${ENABLE_BM25:-true}
      - ENABLE_HYBRID_SEARCH=${ENABLE_HYBRID_SEARCH:-true}

      # Vector Database Configuration
      - VECTOR_STORE_TYPE=${VECTOR_STORE_TYPE:-qdrant}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-enterprise_rag}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}

      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-text}
    volumes:
      # Mount data directories for persistence
      - ./data/documents:/app/data/documents
      - ./logs:/app/logs
    depends_on:
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - rag-network
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  # ============================================================
  # Streamlit UI Service
  # ============================================================
  rag-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: enterprise-rag-ui
    restart: unless-stopped
    ports:
      - "8501:8501"
    environment:
      - API_URL=http://rag-api:8000
    command: >
      streamlit run src/ui/app.py
      --server.port=8501
      --server.address=0.0.0.0
      --server.headless=true
    volumes:
      - ./data/documents:/app/data/documents
    depends_on:
      rag-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M

  # ============================================================
  # Qdrant Vector Database
  # ============================================================
  qdrant:
    image: qdrant/qdrant:v1.11.3
    container_name: enterprise-rag-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC API
    environment:
      - QDRANT__LOG_LEVEL=${LOG_LEVEL:-INFO}
      - QDRANT__SERVICE_HTTP_PORT=6333
      - QDRANT__SERVICE_GRPC_PORT=6334
    volumes:
      # Persist vector data
      - ./data/qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

networks:
  rag-network:
    driver: bridge
    name: enterprise-rag-network

volumes:
  qdrant-storage:
